# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ ComfyUI (SDXL + LoRA)

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü–æ—Å–ª–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞ –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —á–∞—Ç–∞—Ö –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ ¬´üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å¬ª. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `services.image_generation.request_image_on_demand`.
- –ü–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∫–≤–æ—Ç—ã (`image_quota` + –ø–æ–¥–ø–∏—Å–∫–∞), –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è `image_requested`, –¥–∞–ª–µ–µ –∑–∞–ø—Ä–æ—Å —É—Ö–æ–¥–∏—Ç –Ω–∞ ComfyUI. –û—à–∏–±–∫–∞/–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ GPU –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —á–∞—Ç.
- –£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—à–µ—Ç `image_generated`, —Å–ø–∏—Å—ã–≤–∞–µ—Ç –∫–≤–æ—Ç—É (`consume_image`), –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ –≤ Telegram. –û—à–∏–±–∫–∏ ‚Äî `image_failed` —Å reason.

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `.env`:
- `COMFYUI_BASE_URL` ‚Äî `http://GPU_HOST:8188`
- `COMFYUI_TIMEOUT_SECONDS` ‚Äî –æ–±—â–∏–π —Ç–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏/—Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 120)
- `COMFYUI_CONCURRENCY` ‚Äî –º–∞–∫—Å–∏–º—É–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2)
- `COMFYUI_DEFAULT_CHECKPOINT` ‚Äî –∏–º—è —á–µ–∫–ø–æ–∏–Ω—Ç–∞ –≤ ComfyUI (–Ω–∞–ø—Ä–∏–º–µ—Ä `sd_xl_base_1.0.safetensors`)
- `IMAGE_ENABLED` ‚Äî –±—ã—Å—Ç—Ä—ã–π –≤—ã–∫–ª—é—á–∞—Ç–µ–ª—å —Ñ–∏—á–∏

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ LoRA
- –ö–æ–Ω—Ñ–∏–≥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `backend/app/services/persona_images.py`.
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å:
  - `lora_filename` (–ø—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ `ComfyUI/models/lora/`)
  - `lora_strength_model` / `lora_strength_clip`
  - `prompt_core` ‚Äî –∂—ë—Å—Ç–∫–æ–µ —è–¥—Ä–æ –ø—Ä–æ–º–ø—Ç–∞
  - `negative_prompt` ‚Äî –±–∞–∑–æ–≤—ã–π –Ω–µ–≥–∞—Ç–∏–≤
  - `default_style` ‚Äî –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞/–æ—Å–≤–µ—â–µ–Ω–∏–µ
- –ü–æ–∏—Å–∫ –∏–¥—ë—Ç –ø–æ `persona.key` –∏–ª–∏ `persona.name` –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ, –∏–Ω–∞—á–µ –±–µ—Ä—ë—Ç—Å—è `DEFAULT_IMAGE_CONFIG`.
- –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: –¥–æ–±–∞–≤–∏—Ç—å LoRA –≤ ComfyUI, –ø—Ä–æ–ø–∏—Å–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á –≤ `PERSONA_IMAGE_CONFIGS`, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ø—Ä–∞–≤–∏—Ç—å `prompt_core`.

## –®–∞–±–ª–æ–Ω ComfyUI
- –•—Ä–∞–Ω–∏—Ç—Å—è –≤ `backend/app/assets/comfyui/workflows/sdxl_lora.json`.
- –°—Ö–µ–º–∞: `CheckpointLoaderSimple` ‚Üí `LoraLoader` ‚Üí `CLIPTextEncode (¬±)` ‚Üí `EmptyLatentImage` ‚Üí `KSampler` ‚Üí `VAEDecode` ‚Üí `SaveImage`.
- –ö–æ–¥ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —á–µ–∫–ø–æ–∏–Ω—Ç, LoRA, –≤–µ—Å–∞, —Ç–µ–∫—Å—Ç—ã –ø—Ä–æ–º–ø—Ç–æ–≤ –∏ —Å–∏–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ `/prompt`.

## –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã
1. –ë–æ—Ç –æ—Ç–¥–∞—ë—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É ¬´üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å¬ª (–ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —á–∞—Ç—ã).
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–º—ë—Ç –∫–Ω–æ–ø–∫—É ‚Üí `request_image_on_demand` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–≤–æ—Ç—É/–ø–æ–¥–ø–∏—Å–∫—É, –ª–æ–≥–∏—Ä—É–µ—Ç `image_requested`, —Å—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç.
3. –ß–µ—Ä–µ–∑ HTTP (httpx) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ComfyUI: POST `/prompt`, –æ–ø—Ä–æ—Å `/history/{prompt_id}`, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ `/view`.
4. –£—Å–ø–µ—Ö ‚Üí `consume_image`, `image_generated`, –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ. –û—à–∏–±–∫–∏ ‚Üí `image_failed`, —Ç–µ–∫—Å—Ç –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
- –õ–æ–≥–∏: –∏—â–∏—Ç–µ `image_requested`, `image_generated`, `image_failed` –≤ `events_analytics` –∏ stdout.
- –¢–∏–ø–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
  - `COMFYUI_BASE_URL` –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.
  - –ù–µ—Ç –∫–≤–æ—Ç—ã (`image_failed reason=no_quota`).
  - –¢–∞–π–º–∞—É—Ç/–æ—à–∏–±–∫–∞ ComfyUI (`generation_error`).
  - –û—à–∏–±–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ Telegram (`send_error`).
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É ComfyUI –≤—Ä—É—á–Ω—É—é:
  1) `curl -X POST $COMFYUI_BASE_URL/prompt -H 'Content-Type: application/json' -d @backend/app/assets/comfyui/workflows/sdxl_lora.json`
  2) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `/history/{prompt_id}` –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è `images`.
  3) –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —á–µ—Ä–µ–∑ `/view?filename=...`.

## –†—É—á–Ω–æ–π —á–µ–∫–ª–∏—Å—Ç
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å ComfyUI –Ω–∞ GPU, —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å SDXL —á–µ–∫–ø–æ–∏–Ω—Ç –≤ `models/checkpoints`, LoRA —Ñ–∞–π–ª—ã –≤ `models/lora`.
2. –ü—Ä–æ–ø–∏—Å–∞—Ç—å env: `COMFYUI_BASE_URL`, `COMFYUI_DEFAULT_CHECKPOINT`, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å `IMAGE_*`.
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å backend, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç –±–æ—Ç–∞, –Ω–∞–∂–∞—Ç—å ¬´üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å¬ª ‚Üí –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–π—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–≤–æ—Ç–∞).
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º `IMAGE_ENABLED=false` –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è.
