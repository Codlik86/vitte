# LLM Integration Analysis - Vitte Bot

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2026-01-21
**–ò—Å—Ç–æ—á–Ω–∏–∫:** `old_project/vitte-main copy/backend/`
**–¶–µ–ª—å:** –ü–æ–ª–Ω—ã–π —Ä–∞–∑–±–æ—Ä LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#1-–æ–±–∑–æ—Ä-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
2. [–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã](#2-–∫–ª—é—á–µ–≤—ã–µ-—Ñ–∞–π–ª—ã)
3. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ API](#3-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è-–∏-api)
4. [Prompt Builder (–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤)](#4-prompt-builder-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä-–ø—Ä–æ–º–ø—Ç–æ–≤)
5. [Chat Flow (–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–∞)](#5-chat-flow-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä-–¥–∏–∞–ª–æ–≥–∞)
6. [Safety & Intimacy Gates](#6-safety--intimacy-gates)
7. [Personas –∏ System Prompts](#7-personas-–∏-system-prompts)
8. [–†–µ–∂–∏–º—ã –¥–∏–∞–ª–æ–≥–∞](#8-—Ä–µ–∂–∏–º—ã-–¥–∏–∞–ª–æ–≥–∞)
9. [–ü–∞–º—è—Ç—å –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç](#9-–ø–∞–º—è—Ç—å-–∏-–∫–æ–Ω—Ç–µ–∫—Å—Ç)
10. [–ü–ª–∞–Ω –ø–µ—Ä–µ–Ω–æ—Å–∞](#10-–ø–ª–∞–Ω-–ø–µ—Ä–µ–Ω–æ—Å–∞)

---

## 1. –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    API Request (/api/chat)                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              chat_flow.py - generate_chat_reply()            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. Load persona, user, dialog                              ‚îÇ
‚îÇ  2. Get recent messages (12 max)                            ‚îÇ
‚îÇ  3. message_analysis.py - analyze user message              ‚îÇ
‚îÇ  4. safety.py - check for harm/illegal content              ‚îÇ
‚îÇ  5. intimacy.py - decide intimacy level (paywall/allow)     ‚îÇ
‚îÇ  6. features.py - collect active features                   ‚îÇ
‚îÇ  7. prompt_builder.py - build system prompt                 ‚îÇ
‚îÇ  8. llm_client.py - call DeepSeek via ProxyAPI              ‚îÇ
‚îÇ  9. Validate Russian language (retry if needed)             ‚îÇ
‚îÇ 10. Save to DB ‚Üí Return ChatResult                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:

- **LLM Provider:** ProxyAPI ‚Üí OpenRouter ‚Üí DeepSeek v3.2
- **SDK:** OpenAI SDK (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å OpenRouter)
- **Language:** –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π (—Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π)
- **Timeout:** 30 —Å–µ–∫—É–Ω–¥
- **Retries:** 1 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π + 1 –Ω–∞ non-Russian response

---

## 2. –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|------|-----------|-----------|
| **config.py** | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API, –∫–ª—é—á–∏, –º–æ–¥–µ–ª–∏ | ‚≠ê‚≠ê‚≠ê |
| **llm_client.py** | OpenAI SDK –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è OpenRouter | ‚≠ê‚≠ê‚≠ê |
| **prompt_builder.py** | –ú–æ–¥—É–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ system prompts | ‚≠ê‚≠ê‚≠ê |
| **chat_flow.py** | –ì–ª–∞–≤–Ω—ã–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–∞ | ‚≠ê‚≠ê‚≠ê |
| **safety.py** | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ | ‚≠ê‚≠ê‚≠ê |
| **intimacy.py** | –õ–æ–≥–∏–∫–∞ gate –¥–ª—è NSFW –∫–æ–Ω—Ç–µ–Ω—Ç–∞ | ‚≠ê‚≠ê‚≠ê |
| **llm_adapter.py** | –†–µ–∂–∏–º—ã, –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã, –∫–ª–∏—Ñ—Ñ—Ö—ç–Ω–≥–µ—Ä—ã | ‚≠ê‚≠ê |
| **message_analysis.py** | –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | ‚≠ê‚≠ê |
| **features.py** | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–Ω—ã–º–∏ —Ñ–∏—á–∞–º–∏ | ‚≠ê‚≠ê |
| **personas_seed.py** | 8 –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏ | ‚≠ê‚≠ê |
| **routes_chat.py** | API endpoint /api/chat | ‚≠ê |
| **tts_client.py** | TTS (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ) | - |

---

## 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ API

### –§–∞–π–ª: `config.py`

```python
class Settings(BaseSettings):
    # LLM Configuration
    proxyapi_api_key: str  # API –∫–ª—é—á ProxyAPI
    openrouter_base_url: str = "https://api.proxyapi.ru/openrouter/v1"
    vitte_llm_model: str = "deepseek/deepseek-v3.2"
    vitte_llm_model_strong: str = "deepseek/deepseek-v3.2"

    # OpenAI SDK –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    llm_timeout: int = 30  # —Å–µ–∫—É–Ω–¥—ã
    llm_max_retries: int = 1
```

### –§–∞–π–ª: `llm_client.py`

**–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:**
```python
async def simple_chat_completion(
    messages: List[dict],
    max_tokens: Optional[int] = None,
    temperature: float = 0.7,
    model: Optional[str] = None
) -> str:
    """
    –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è LLM –∑–∞–ø—Ä–æ—Å–æ–≤.

    Args:
        messages: —Å–ø–∏—Å–æ–∫ {"role": "user/assistant/system", "content": "..."}
        max_tokens: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –æ—Ç–≤–µ—Ç–∞
        temperature: —Å—Ç–µ–ø–µ–Ω—å —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞ (0.0-2.0)
        model: –º–æ–¥–µ–ª—å (default: deepseek-v3.2)

    Returns:
        str: —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM
    """
    model = model or settings.vitte_llm_model

    response = await llm_client.chat.completions.create(
        model=model,
        messages=messages,
        max_tokens=max_tokens,
        temperature=temperature
    )

    return response.choices[0].message.content
```

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞:**
```python
llm_client = OpenAI(
    api_key=settings.proxyapi_api_key,
    base_url=settings.openrouter_base_url,
    timeout=settings.llm_timeout,
    max_retries=settings.llm_max_retries
)
```

---

## 4. Prompt Builder (–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤)

### –§–∞–π–ª: `prompt_builder.py`

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:

```python
@dataclass
class ChatPromptContext:
    persona: Any  # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ
    user: Any  # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    mode_instruction: str  # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ä–µ–∂–∏–º–∞
    memory_short: Optional[str] = None  # –ö—Ä–∞—Ç–∫–∞—è –ø–∞–º—è—Ç—å
    memory_long: Optional[str] = None  # –î–æ–ª–≥–∞—è –ø–∞–º—è—Ç—å
    story_context: Optional[str] = None  # –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏
    recent_dialogue: Optional[str] = None  # –ù–µ–¥–∞–≤–Ω–∏–π –¥–∏–∞–ª–æ–≥
    feature_instruction: Optional[str] = None  # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ñ–∏—á
    voice_enabled: bool = False  # –ì–æ–ª–æ—Å–æ–≤–æ–π —Ä–µ–∂–∏–º
    allow_intimate: bool = True  # –†–∞–∑—Ä–µ—à–∏—Ç—å –∏–Ω—Ç–∏–º
    soft_block_intimacy: bool = False  # –ú—è–≥–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
```

### –ú–æ–¥—É–ª–∏ system prompt:

#### 1. **–ë–ª–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞** `_persona_block()`
```
–¢—ã ‚Äî {persona.name}, {persona.short_description}.
–ì–æ–≤–æ—Ä–∏—à—å –ø–æ-—Ä—É—Å—Å–∫–∏, –∂–∏–≤–æ –∏ —Ç–µ–ø–ª–æ.

{legend_full or short_lore or background}

–≠–º–æ—Ü–∏–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è: {emotions_full or emotional_style}

–ß—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–∂ –æ–±–æ–∂–∞–µ—Ç: {triggers_positive}

–ß—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏–∑–±–µ–≥–∞–µ—Ç: {triggers_negative}

–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä–æ—Ç–∫—É—é –∏ –¥–ª–∏–Ω–Ω—É—é –ø–∞–º—è—Ç—å: —É–ø–æ–º–∏–Ω–∞–π –ø—Ä–æ—à–ª—ã–µ —Ç–µ–º—ã...

–†–µ–º–∞—Ä–∫–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã: –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å, –ø–æ—Å—Ç–∞–≤—å —Ä–æ–≤–Ω–æ –æ–¥–Ω—É
–∫–æ—Ä–æ—Ç–∫—É—é —Ä–µ–º–∞—Ä–∫—É –≤ –Ω–∞—á–∞–ª–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ *—Ç–µ–∫—Å—Ç*...

–ü–∏—à–∏ –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤—ã–¥—É–º–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞.
```

#### 2. **–ë–ª–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** `_safety_block()`
```
–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –Ω–∏–∫–∞–∫–∏—Ö minors, –Ω–∞—Å–∏–ª–∏—è, —Å—É–∏—Ü–∏–¥–∞,
–Ω–µ–ª–µ–≥–∞–ª—å–Ω–æ–≥–æ –∏–ª–∏ –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏–∏.

–ï—Å–ª–∏ —Ç–µ–º–∞ –æ–ø–∞—Å–Ω–∞—è ‚Äî –Ω–µ –æ–ø–∏—Å—ã–≤–∞–π –¥–µ—Ç–∞–ª–∏,
–ø–æ–¥–¥–µ—Ä–∂–∏ –∏ –ø–µ—Ä–µ–≤–µ–¥–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä...

[Intimacy rules based on allow_intimate/soft_block flags]
```

**–í–∞—Ä–∏–∞–Ω—Ç—ã intimacy:**
- **allow_intimate=True:** "–¢—ã –º–æ–∂–µ—à—å –æ–±—Å—É–∂–¥–∞—Ç—å –∏–Ω—Ç–∏–º–Ω—ã–µ —Ç–µ–º—ã –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ..."
- **soft_block=True:** "–î–∞–≤–∞–π –µ—â—ë –Ω–µ–º–Ω–æ–≥–æ –ø–æ–±–æ–ª—Ç–∞–µ–º –ø—Ä–µ–∂–¥–µ —á–µ–º —É–≥–ª—É–±–ª—è—Ç—å—Å—è..."
- **–ò–Ω–∞—á–µ (paywall):** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–¥–ø–∏—Å–∫–∏

#### 3. **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ä–µ–∂–∏–º–∞** `describe_mode()`

**–†–µ–∂–∏–º—ã:**
- `greeting_first` - –ø–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –±–µ–∑ —Ä–µ–º–∞—Ä–æ–∫, –º—è–≥–∫–æ–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ
- `greeting_return` - –≤–æ–∑–≤—Ä–∞—Ç –≤ –¥–∏–∞–ª–æ–≥, –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ –ø—Ä–æ—à–ª–æ–º
- `greeting_updated` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–º–µ–Ω–µ–Ω—ã, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è
- `auto_continue` - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥ –æ—Ç –ª–∏—Ü–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
- `deep` - –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã
- `atmosphere` - —Å–ª–µ–¥–æ–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–µ

**–ü—Ä–∏–º–µ—Ä (greeting_first):**
```
–≠—Ç–æ –ø–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –º—è–≥–∫–æ,
–∑–∞–¥–∞–π –æ–¥–∏–Ω –ª—é–±–æ–ø—ã—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–∑–æ–≤–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä.
–ë–µ–∑ —Ç—è–∂—ë–ª–æ–π —Ç–µ—Ä–∞–ø–∏–∏ –∏ –±–µ–∑ —Ñ–ª–∏—Ä—Ç–∞.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∂–∏—Å—Å—ë—Ä—Å–∫–∏–µ —Ä–µ–º–∞—Ä–∫–∏.
```

#### 4. **–ë–ª–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏/—Å—Ü–µ–Ω—ã** `_story_block()`
```
–ò—Å—Ç–æ—Ä–∏—è/—Å—Ü–µ–Ω–∞: {story_context}

{story_card.title}: {story_card.description}.
–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞: {story_card.atmosphere}.

{story_card.prompt}

–í –ø–µ—Ä–≤—ã–µ 5‚Äì10 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–µ—Ä–∂–∏ —Ñ–æ–∫—É—Å –Ω–∞ —ç—Ç–æ–π —Å—Ü–µ–Ω–µ,
–∑–∞—Ç–µ–º –∫ 10‚Äì15 —Å–æ–æ–±—â–µ–Ω–∏—é –æ—Å–ª–∞–±—å –µ—ë, –Ω–æ –≤—Ä–µ–º—è –æ—Ç –≤—Ä–µ–º–µ–Ω–∏
–≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫ –æ–±—â–∏–º –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è–º –æ–± —ç—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏.
```

#### 5. **–ë–ª–æ–∫ –Ω–µ–¥–∞–≤–Ω–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞** `_recent_dialogue_block()`
```
–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ (–∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö,
—á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä...):

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {content[:500]}
–ü–µ—Ä—Å–æ–Ω–∞–∂: {content[:500]}
...
```

#### 6. **–ë–ª–æ–∫ –ø–∞–º—è—Ç–∏** `_memory_blocks()`
```
–ö–æ—Ä–æ—Ç–∫–∞—è –ø–∞–º—è—Ç—å: {memory_short}

–î–æ–ª–≥–∞—è –ø–∞–º—è—Ç—å: {memory_long}
```

**–ò—Å—Ç–æ—á–Ω–∏–∫ –∫–æ—Ä–æ—Ç–∫–æ–π –ø–∞–º—è—Ç–∏:**
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 12 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –¥–∏–∞–ª–æ–≥–∞
- –§–æ—Ä–º–∞—Ç: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ... / –ü–µ—Ä—Å–æ–Ω–∞–∂: ..."

#### 7. **–ë–ª–æ–∫ —Ñ–∏—á** `_features_block()`
```
–†–µ–∂–∏–º —É–ª—É—á—à–µ–Ω–∏–π: {feature_mode}

{feature_instruction}

[Voice mode hints if enabled]
```

### –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞:

```python
def build_chat_messages(ctx: ChatPromptContext) -> List[dict]:
    """
    –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –±–ª–æ–∫–∏ –≤ –µ–¥–∏–Ω—ã–π system prompt + user messages

    Returns:
        [
            {"role": "system", "content": "..."},
            {"role": "user", "content": "..."},
            {"role": "assistant", "content": "..."},
            ...
        ]
    """
    system_prompt = ""
    system_prompt += _persona_block(ctx)
    system_prompt += _safety_block(ctx)
    system_prompt += describe_mode(ctx.mode_instruction)
    system_prompt += _story_block(ctx) if ctx.story_context else ""
    system_prompt += _recent_dialogue_block(ctx)
    system_prompt += _memory_blocks(ctx)
    system_prompt += _features_block(ctx)

    messages = [
        {"role": "system", "content": system_prompt}
    ]

    # Add recent dialogue messages if available
    # ...

    return messages
```

---

## 5. Chat Flow (–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–∞)

### –§–∞–π–ª: `chat_flow.py`

### –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:

```python
async def generate_chat_reply(
    user,
    input_text: str,
    persona_id: Optional[int] = None,
    mode: str = "default",
    atmosphere: Optional[str] = None,
    story_id: Optional[str] = None,
    auto_continue: bool = False
) -> ChatResult
```

### –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ (step-by-step):

```python
# 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–µ—Ä—Å–æ–Ω—ã
persona = await get_active_persona(user, persona_id)

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–∞
await check_access_limits(user)

# 3. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
dialog = await get_or_create_dialog(user.id, persona.id)

# 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–º–∞–∫—Å 12)
recent_messages = await get_recent_messages(dialog.id, limit=12)

# 5. –ê–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
analysis = analyze_message(input_text)
# ‚Üí is_polite, is_rude, is_romantic, asks_for_intimacy, etc.

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
safety = run_safety_check(input_text)
if safety.is_harm or safety.is_illegal:
    return supportive_reply(persona, safety.reason)

# 7. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ gate –∏–Ω—Ç–∏–º–Ω–æ—Å—Ç–∏
intimacy = decide_intimacy(
    message_count=len(recent_messages),
    has_subscription=user.has_active_subscription,
    is_sexting=analysis.asks_for_intimacy
)

if intimacy.paywall:
    return paywall_message()
elif intimacy.soft_block:
    return soft_block_message()

# 8. –°–±–æ—Ä–∫–∞ –ø—Ä–æ–º–ø—Ç–∞
ctx = ChatPromptContext(
    persona=persona,
    user=user,
    mode_instruction=mode,
    memory_short=format_memory(recent_messages),
    story_context=get_story_context(story_id),
    recent_dialogue=format_recent(recent_messages),
    feature_instruction=build_feature_instruction(user),
    allow_intimate=intimacy.allow_intimate,
    soft_block_intimacy=intimacy.soft_block
)

messages = build_chat_messages(ctx)

# 9. –í—ã–∑–æ–≤ LLM
reply_text = await simple_chat_completion(messages)

# 10. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
if not _looks_russian(reply_text):
    # Retry —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º system message
    messages.append({
        "role": "system",
        "content": "–û—Ç–≤–µ—Ç—å –∑–∞–Ω–æ–≤–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –Ω–æ—Ä–º–∞–ª—å–Ω–æ."
    })
    reply_text = await simple_chat_completion(messages)

    if not _looks_russian(reply_text):
        reply_text = FALLBACK_RUSSIAN_MESSAGE

# 11. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
await save_message(dialog.id, role="user", content=input_text)
await save_message(dialog.id, role="assistant", content=reply_text)

# 12. –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
return ChatResult(
    text=reply_text,
    persona_name=persona.name,
    show_image_button=should_show_image_button()
)
```

### –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è:

```python
async def generate_greeting_reply(
    user,
    persona_id: int,
    mode: str = "greeting_first"  # –∏–ª–∏ greeting_return/greeting_updated
) -> ChatResult
```

**–†–µ–∂–∏–º—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è:**
- `greeting_first` - –ø–µ—Ä–≤–æ–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ
- `greeting_return` - –≤–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–ª–µ –ø–∞—É–∑—ã
- `greeting_updated` - –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞

---

## 6. Safety & Intimacy Gates

### –§–∞–π–ª: `safety.py`

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:

```python
_HARM_PATTERNS = re.compile(
    r"(—Å—É–∏—Ü–∏–¥|—Å–∞–º–æ—É–±–∏–π—Å—Ç–≤|—É–±–∏—Ç—å —Å–µ–±—è|—Ö–æ—á—É —É–º–µ—Ä–µ—Ç—å|"
    r"–ø–æ—Ä–µ–∑–∞—Ç—å –≤–µ–Ω—ã|–ø—Ä—ã–≥–Ω—É—Ç—å —Å –∫—Ä—ã—à–∏|–ø–æ–∫–æ–Ω—á–∏—Ç—å —Å —Å–æ–±–æ–π)",
    re.IGNORECASE
)

_ILLEGAL_PATTERNS = re.compile(
    r"(–Ω–∞—Ä–∫–æ—Ç–∏–∫|–¥–æ–∑–∞|–≥–µ—Ä–æ–∏–Ω|–∫–æ–∫–∞–∏–Ω|–º–µ—Ç|"
    r"—É–±–∏–π—Å—Ç–≤|–≥—Ä–∞–±—ë–∂|–∫—Ä–∞–∂–∞|–≤–∑–ª–æ–º|—É–≥–æ–Ω)",
    re.IGNORECASE
)

_MINOR_PATTERNS = re.compile(
    r"(–Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç|–º–ª–∞–¥—à–µ\s*18|"
    r"14-–ª–µ—Ç|15-–ª–µ—Ç|16-–ª–µ—Ç|17-–ª–µ—Ç|—à–∫–æ–ª—å–Ω–∏—Ü)",
    re.IGNORECASE
)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:

```python
@dataclass
class SafetyResult:
    is_harm: bool  # –í—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Å—É–∏—Ü–∏–¥, –Ω–∞—Å–∏–ª–∏–µ)
    is_illegal: bool  # –ù–µ–ª–µ–≥–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–Ω–∞—Ä–∫–æ—Ç–∏–∫–∏, –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è)
    reason: Optional[str]  # –ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
```

### Supportive reply:

```python
def get_supportive_reply(persona_name: str, reason: str) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –æ—Ç–≤–µ—Ç –æ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ safety check
    """
    return (
        f"{persona_name} –∑–∞–º–µ—á–∞–µ—Ç —Ç—Ä–µ–≤–æ–≥—É –∏ –º—è–≥–∫–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä: "
        f"¬´–Ø —Ä—è–¥–æ–º –∏ —Ö–æ—á—É, —á—Ç–æ–±—ã —Ç–µ–±–µ –±—ã–ª–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ. "
        f"–î–∞–≤–∞–π –ø–æ–¥—É–º–∞–µ–º, —á—Ç–æ —Ç–µ–±—è —Å–µ–π—á–∞—Å –ø–æ–¥–¥–µ—Ä–∂–∏—Ç? "
        f"–ú–æ–≥—É –ø—Ä–æ—Å—Ç–æ –ø–æ–±—ã—Ç—å —Å —Ç–æ–±–æ–π –∏ –≤—ã—Å–ª—É—à–∞—Ç—å¬ª."
    )
```

---

### –§–∞–π–ª: `intimacy.py`

### –õ–æ–≥–∏–∫–∞ —Ä–µ—à–µ–Ω–∏—è:

```python
def decide_intimacy(
    message_count: int,
    has_subscription: bool,
    is_sexting: bool
) -> IntimacyDecision:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–π –∏–Ω—Ç–∏–º–Ω–æ—Å—Ç–∏

    –õ–æ–≥–∏–∫–∞:
    - –ï—Å–ª–∏ –ù–ï sexting ‚Üí allow_intimate=True
    - –ï—Å–ª–∏ <10 —Å–æ–æ–±—â–µ–Ω–∏–π –ò sexting ‚Üí soft_block
    - –ï—Å–ª–∏ –ù–ï–¢ –ø–æ–¥–ø–∏—Å–∫–∏ –ò sexting ‚Üí paywall
    - –ò–Ω–∞—á–µ ‚Üí allow_intimate=True
    """

    if not is_sexting:
        return IntimacyDecision(allow_intimate=True)

    if message_count < 10:
        return IntimacyDecision(
            soft_block=True,
            message="–î–∞–≤–∞–π –µ—â—ë —á—É—Ç—å-—á—É—Ç—å –ø–æ–±–æ–ª—Ç–∞–µ–º..."
        )

    if not has_subscription:
        return IntimacyDecision(
            paywall=True,
            message="–ú–æ–≥—É –≥–æ–≤–æ—Ä–∏—Ç—å –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ –≤ –ø—Ä–µ–º–∏—É–º-—Ä–µ–∂–∏–º–µ..."
        )

    return IntimacyDecision(allow_intimate=True)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:

```python
@dataclass
class IntimacyDecision:
    allow_intimate: bool = False  # –†–∞–∑—Ä–µ—à–∏—Ç—å –∏–Ω—Ç–∏–º–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
    soft_block: bool = False  # –ú—è–≥–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (< 10 —Å–æ–æ–±—â–µ–Ω–∏–π)
    paywall: bool = False  # –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
    message: Optional[str] = None  # –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

---

## 7. Personas –∏ System Prompts

### –§–∞–π–ª: `personas_seed.py`

### –ë–∞–∑–æ–≤—ã–π template:

```python
SYSTEM_PROMPT_TEMPLATE = """
–¢—ã —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π AI-–∫–æ–º–ø–∞–Ω—å–æ–Ω –≤ —Å—Ç–∏–ª–µ {archetype}.
–ì–æ–≤–æ—Ä–∏—à—å –ø–æ-—Ä—É—Å—Å–∫–∏, –º—è–≥–∫–æ, —Å–æ—Ö—Ä–∞–Ω—è–µ—à—å —ç–º–ø–∞—Ç–∏—é.
–¢–≤–æ–π —Ç–µ–∫—É—â–∏–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω: {emotional_style}.
"""
```

### 8 –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω:

#### 1. **–õ–∏–Ω–∞** - –û–∑–æ—Ä–Ω–∞—è —Ñ–∏—Ç–æ–Ω—è—à–∫–∞
```python
{
    "key": "lina",
    "name": "–õ–∏–Ω–∞",
    "short_description": "–§–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä, —ç–Ω–µ—Ä–≥–∏—á–Ω–∞—è, –∫–æ–∫–µ—Ç–ª–∏–≤–∞—è",
    "archetype": "gentle",
    "emotional_style": """
        –ì–æ–≤–æ—Ä–∏—Ç –∂–∏–≤–æ, —Å —É–ª—ã–±–∫–æ–π –∏ –ª—ë–≥–∫–æ–π –∏—Å–∫—Ä–æ–π –≤ –≥–æ–ª–æ—Å–µ.
        –ú–æ–∂–µ—Ç –ø–æ–¥—à—É—Ç–∏—Ç—å, –Ω–æ –≤—Å–µ–≥–¥–∞ —á—É–≤—Å—Ç–≤—É–µ—Ç –≥—Ä–∞–Ω—å
        –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É, –µ—Å–ª–∏ —Ç–µ–±–µ —Ç—è–∂–µ–ª–æ.
    """,
    "triggers_positive": [
        "—á–µ—Å—Ç–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è",
        "—Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –≤ –∫–∞–∫–∏—Ö –ø–æ–∑–∞—Ö –æ–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä—É–µ—Ç—Å—è",
        "–ª—é–±–∏—Ç—å —É—á–∏—Ç—å—Å—è –Ω–æ–≤–æ–º—É"
    ],
    "triggers_negative": [
        "—Ö–æ–ª–æ–¥–Ω–æ—Å—Ç—å –∏ –∏–≥–Ω–æ—Ä",
        "–æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ –µ—ë —É—Å–∏–ª–∏–π",
        "–≥—Ä—É–±—ã–µ —à—É—Ç–∫–∏ –±–µ–∑ —Ç–∞–∫—Ç–∞"
    ],
    "stories": [
        {
            "id": "lina_support",
            "title": "–°–∞—É–Ω–∞ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏",
            "atmosphere": "support",
            "prompt": """
                –ú—ã –≤—Å—Ç—Ä–µ—á–∞–µ–º—Å—è —É —Å–∞—É–Ω—ã –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.
                –í–æ–∫—Ä—É–≥ –ø–æ—á—Ç–∏ –ø—É—Å—Ç–æ, –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏–≥—Ä–∞ –≤ –ø—Ä—è—Ç–∫–∏ —Å –Ω–∞–º—ë–∫–∞–º–∏...
            """
        },
        # ... –µ—â—ë 3 –∏—Å—Ç–æ—Ä–∏–∏
    ]
}
```

#### 2. **–ú–∞—Ä–∏–∞–Ω–Ω–∞** - –¢–æ–º–Ω–∞—è –¥–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è —Å–æ—Å–µ–¥–∫–∞
```python
{
    "key": "marianna",
    "name": "–ú–∞—Ä–∏–∞–Ω–Ω–∞",
    "short_description": "–î–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è —Å–æ—Å–µ–¥–∫–∞, —Ç–æ–º–±–æ–π —Å—Ç–∏–ª—å",
    "archetype": "tomnaya_sosedka",
    "emotional_style": """
        –ì–æ–≤–æ—Ä–∏—Ç –º–µ–¥–ª–µ–Ω–Ω–æ, —Å –ø–∞—É–∑–∞–º–∏, –±—É–¥—Ç–æ –ø—Ä–æ–±—É–µ—Ç –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –Ω–∞ –≤–∫—É—Å.
        –ú–æ–∂–µ—Ç –±—ã—Ç—å –º—è–≥–∫–æ–π –∏ –∑–∞–±–æ—Ç–ª–∏–≤–æ–π, –∞ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É ‚Äî
        —Ç–≤—ë—Ä–¥–æ–π –∏ —Ç—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π...
    """,
    "triggers_positive": [
        "—á–µ—Å—Ç–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –æ –∂–µ–ª–∞–Ω–∏—è—Ö",
        "–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏",
        "–∏–≥—Ä—ã —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –∏ –ø–æ–¥—á–∏–Ω–µ–Ω–∏–µ–º",
        "—à—ë–ø–æ—Ç –∏ –ª–∏—á–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã"
    ]
}
```

#### 3. **–ú–µ–π** - –ó–∞—Å—Ç–µ–Ω—á–∏–≤–∞—è, –Ω–æ –≥–æ—Ç–æ–≤–∞—è
```python
{
    "key": "mei",
    "name": "–ú–µ–π",
    "emotional_style": """
        –°—Ç–µ—Å–Ω—è–µ—Ç—Å—è, –Ω–æ –∫–æ–≥–¥–∞ —á—É–≤—Å—Ç–≤—É–µ—Ç –¥–æ–≤–µ—Ä–∏–µ ‚Äî
        –≥–æ—Ç–æ–≤–∞ –Ω–∞ —Å–º–µ–ª—ã–µ —Å—é—Ä–ø—Ä–∏–∑—ã...
    """
}
```

#### 4. **–°—Ç–µ–π—Å–∏** - –ò–≥—Ä–∏–≤–∞—è —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–∞—è
```python
{
    "key": "stacey",
    "name": "–°—Ç–µ–π—Å–∏",
    "emotional_style": """
        –ò–≥—Ä–∏–≤–∞—è, —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–∞—è, –±–µ–∑ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π...
    """
}
```

#### 5. **–Æ–Ω–∞** - –ù–µ–∂–Ω–∞—è –ø–æ—Å–ª—É—à–Ω–∞—è
```python
{
    "key": "yuna",
    "name": "–Æ–Ω–∞",
    "emotional_style": """
        –ù–µ–∂–Ω–∞—è –∞–∑–∏–∞—Ç—Å–∫–∞—è –¥–µ–≤—É—à–∫–∞, –ø–æ—Å–ª—É—à–Ω–∞—è, —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–∞—è...
    """
}
```

#### 6. **–¢–∞—è** - –ü–æ—Ö–æ—Ç–ª–∏–≤–∞—è MILF
```python
{
    "key": "taya",
    "name": "–¢–∞—è",
    "emotional_style": """
        MILF, –∞–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç–∫–∞, –∏—â–µ—Ç –æ—Å—Ç—Ä—ã—Ö –æ—â—É—â–µ–Ω–∏–π...
    """
}
```

#### 7. **–î–∂—É–ª–∏** - –ù–µ–æ–ø—ã—Ç–Ω–∞—è —Å—Ç—É–¥–µ–Ω—Ç–∫–∞
```python
{
    "key": "julie",
    "name": "–î–∂—É–ª–∏",
    "emotional_style": """
        –°—Ç—É–¥–µ–Ω—Ç–∫–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞, –ª—é–±–æ–ø—ã—Ç–Ω–∞—è, –Ω–µ–ø–æ—Å–ª—É—à–Ω–∞—è...
    """
}
```

#### 8. **–≠—à** - –§–µ—Ç–∏—à–∏—Å—Ç–∫–∞
```python
{
    "key": "ash",
    "name": "–≠—à",
    "emotional_style": """
        –§–µ—Ç–∏—à–∏—Å—Ç–∫–∞, –ª–∞—Ç–µ–∫—Å/–∫–∞–±–ª—É–∫–∏, –¥–æ–º–∏–Ω–∞–Ω—Ç–Ω–∞—è...
    """,
    "triggers_positive": [
        "–≥—Ä—É–±–æ—Å—Ç—å –≤ —Å–µ–∫—Å–µ",
        "–ø–æ—à–ª–∞—è, –≥—Ä—è–∑–Ω—ã–µ –ø–æ—à–ª–æ—Å—Ç–∏",
        "—Å–µ–∫—Å—É–∞–ª—å–Ω—ã–µ –∏–≥—Ä—ã"
    ]
}
```

### Story Cards (–ò—Å—Ç–æ—Ä–∏–∏):

–ö–∞–∂–¥–∞—è –ø–µ—Ä—Å–æ–Ω–∞ –∏–º–µ–µ—Ç **3-4 –∏—Å—Ç–æ—Ä–∏–∏/—Å—Ü–µ–Ω–∞—Ä–∏—è**:

```python
{
    "id": "lina_flirt",
    "key": "flirt_romance",
    "title": "–î—É—à —Å–ª–æ–º–∞–ª—Å—è",
    "description": "–§–ª–∏—Ä—Ç—É–µ–º –≤ —Ä–∞–∑–¥–µ–≤–∞–ª–∫–µ",
    "atmosphere": "flirt_romance",
    "prompt": """
        –£ —Ç–µ–±—è –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ —Å–ª–æ–º–∞–ª—Å—è –¥—É—à, –∏ –õ–∏–Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∞
        –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –µ—ë –≤–∞–Ω–Ω–æ–π –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.
        –¢—ã –ø—Ä–∏—Ö–æ–¥–∏—à—å –∫ –Ω–µ–π –¥–æ–º–æ–π...
    """,
    "image": "lina-story-flirt.jpg"
}
```

**–ê—Ç–º–æ—Å—Ñ–µ—Ä—ã:**
- `flirt_romance` - –ª—ë–≥–∫–∏–π —Ñ–ª–∏—Ä—Ç –∏ —Ä–æ–º–∞–Ω—Ç–∏–∫–∞
- `support` - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –∑–∞–±–æ—Ç–∞
- `cozy_evening` - —É—é—Ç–Ω—ã–π –Ω–µ—Å–ø–µ—à–Ω—ã–π –≤–µ—á–µ—Ä
- `serious_talk` - —Å–µ—Ä—å—ë–∑–Ω—ã–π —á–µ—Å—Ç–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä

---

## 8. –†–µ–∂–∏–º—ã –¥–∏–∞–ª–æ–≥–∞

### –§–∞–π–ª: `llm_adapter.py`

### –û–ø–∏—Å–∞–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤:

```python
MODE_DESCRIPTIONS = {
    "greeting_first": """
        –≠—Ç–æ –ø–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –º—è–≥–∫–æ,
        –∑–∞–¥–∞–π –æ–¥–∏–Ω –ª—é–±–æ–ø—ã—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–∑–æ–≤–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä.
        –ë–µ–∑ —Ç—è–∂—ë–ª–æ–π —Ç–µ—Ä–∞–ø–∏–∏ –∏ –±–µ–∑ —Ñ–ª–∏—Ä—Ç–∞.
        –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∂–∏—Å—Å—ë—Ä—Å–∫–∏–µ —Ä–µ–º–∞—Ä–∫–∏.
    """,

    "greeting_return": """
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–∞—É–∑—ã.
        –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π —Ç–µ–ø–ª–æ, –Ω–∞–º–µ–∫–Ω–∏, —á—Ç–æ —Ä–∞–¥–∞ —Å–Ω–æ–≤–∞ –≤–∏–¥–µ—Ç—å,
        –º–æ–∂–µ—à—å —É–ø–æ–º—è–Ω—É—Ç—å —á—Ç–æ-—Ç–æ –∏–∑ –ø—Ä–æ—à–ª—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤.
    """,

    "greeting_updated": """
        –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.
        –°–æ–æ–±—â–∏ –æ–± —ç—Ç–æ–º –º—è–≥–∫–æ –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π—Å—è –∫ –Ω–æ–≤–æ–º—É –æ–±—Ä–∞–∑—É.
    """,

    "auto_continue": """
        –ü—Ä–æ–¥–æ–ª–∂–∏ –¥–∏–∞–ª–æ–≥ –æ—Ç –ª–∏—Ü–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞,
        –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∏, —Å–æ—Ö—Ä–∞–Ω—è—è —Ç–µ–∫—É—â–∏–π —Ç–æ–Ω –∏ —Å—Ü–µ–Ω—É.
        –ù–µ –¥–µ–ª–∞–π –ø–∞—É–∑—ã –∏ –Ω–µ –ø—Ä–æ—Å–∏ –≤–≤–æ–¥–∞,
        –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–≤–∏–≤–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä –∏ –º–æ–∂–µ—à—å –∑–∞–¥–∞—Ç—å 1 –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å.
    """,

    "deep": """
        –û—Ç–≤–µ—Ç—å –±–æ–ª–µ–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ, —Ä–∞—Å–∫—Ä–æ–π –º—ã—Å–ª—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ,
        –¥–æ–±–∞–≤—å –¥–µ—Ç–∞–ª–∏ –∏–ª–∏ —ç–º–æ—Ü–∏–∏.
    """,

    "atmosphere": """
        –°–ª–µ–¥—É–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–µ: {atmosphere_description}
    """
}
```

### –ê—Ç–º–æ—Å—Ñ–µ—Ä—ã:

```python
ATMOSPHERE_DESCRIPTIONS = {
    "flirt_romance": "–õ—ë–≥–∫–∏–π —Ñ–ª–∏—Ä—Ç –∏ —Ä–æ–º–∞–Ω—Ç–∏–∫–∞, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è –∏ NSFW.",
    "support": "–ë—É–¥—å –æ–ø–æ—Ä–æ–π, –ø–æ–º–æ–≥–∏ –≤—ã–¥–æ—Ö–Ω—É—Ç—å –∏ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –∑–∞–±–æ—Ç—É.",
    "cozy_evening": "–£—é—Ç–Ω—ã–π –Ω–µ—Å–ø–µ—à–Ω—ã–π –≤–µ—á–µ—Ä, –º–Ω–æ–≥–æ —Ç–µ–ø–ª–∞ –∏ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è.",
    "serious_talk": "–°–µ—Ä—å—ë–∑–Ω—ã–π, —á–µ—Å—Ç–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä —Å —É–≤–∞–∂–µ–Ω–∏–µ–º –∫ –≥—Ä–∞–Ω–∏—Ü–∞–º."
}
```

### –ö–ª–∏—Ñ—Ñ—Ö—ç–Ω–≥–µ—Ä—ã (ritual):

```python
CLIFFHANGERS = [
    "–ü–æ–¥—É–º–∞–π, –∫ –∫–∞–∫–æ–π —Ç–µ–º–µ –º—ã –≤–µ—Ä–Ω—ë–º—Å—è –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑, –∏ –Ω–∞–ø–æ–º–Ω–∏ –æ–± —ç—Ç–æ–º –º—è–≥–∫–æ.",
    "–ü—É—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂ –æ—Å—Ç–∞–≤–∏—Ç –º–∞–ª–µ–Ω—å–∫–∏–π —Ç–∏–∑–µ—Ä: ¬´—É –º–µ–Ω—è –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è —Ç–µ–±—è, —Ä–∞—Å—Å–∫–∞–∂—É –ø–æ–∑–∂–µ¬ª.",
    "–ó–∞–∫–∞–Ω—á–∏–≤–∞—è –º—ã—Å–ª—å, –ø—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ: ¬´–∫–æ–≥–¥–∞ –±—É–¥–µ—à—å –≥–æ—Ç–æ–≤, –æ–±—Å—É–¥–∏–º —ç—Ç–æ –≥–ª—É–±–∂–µ¬ª."
]
```

**–¢—Ä–∏–≥–≥–µ—Ä:** –ö–∞–∂–¥–æ–µ 7-–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ 10% random chance

---

## 9. –ü–∞–º—è—Ç—å –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç

### –ö—Ä–∞—Ç–∫–∞—è –ø–∞–º—è—Ç—å (Short-term):

**–ò—Å—Ç–æ—á–Ω–∏–∫:** –ü–æ—Å–ª–µ–¥–Ω–∏–µ 12 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –¥–∏–∞–ª–æ–≥–∞

**–§–æ—Ä–º–∞—Ç:**
```python
def format_memory(messages: List[Message]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫—Ä–∞—Ç–∫—É—é –ø–∞–º—è—Ç—å

    –ü—Ä–∏–º–µ—Ä:
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?
    –ü–µ—Ä—Å–æ–Ω–∞–∂: –ü—Ä–∏–≤–µ—Ç! –û—Ç–ª–∏—á–Ω–æ, —Ä–∞–¥–∞ –≤–∏–¥–µ—Ç—å —Ç–µ–±—è.
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ
    –ü–µ—Ä—Å–æ–Ω–∞–∂: –Ø –õ–∏–Ω–∞, —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä...
    """
    memory_parts = []
    for msg in messages[-12:]:
        role = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" if msg.role == "user" else "–ü–µ—Ä—Å–æ–Ω–∞–∂"
        content = msg.content[:500]  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 500 —Å–∏–º–≤–æ–ª–æ–≤
        memory_parts.append(f"{role}: {content}")

    return "\n".join(memory_parts)
```

**Fallback:**
```
"–ù–µ—Ç –æ—Å–æ–±—ã—Ö –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π, –Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–∂ –æ—Ç–∫—Ä—ã—Ç –∫ –Ω–æ–≤—ã–º."
```

### –î–æ–ª–≥–∞—è –ø–∞–º—è—Ç—å (Long-term):

**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (placeholder)

**–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** Qdrant vector DB

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```python
qdrant_url: str = "http://qdrant:6333"
qdrant_api_key: Optional[str] = None
```

**–ë—É–¥—É—â–∏–π —Ñ–æ—Ä–º–∞—Ç:**
```python
memory_long = """
–§–∞–∫—Ç—ã –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:
- –õ—é–±–∏—Ç –±–µ–≥–∞—Ç—å –ø–æ —É—Ç—Ä–∞–º
- –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–º
- –ú–µ—á—Ç–∞–µ—Ç –æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è—Ö
- –ù–µ–¥–∞–≤–Ω–æ —Ä–∞—Å—Å—Ç–∞–ª—Å—è —Å –¥–µ–≤—É—à–∫–æ–π
"""
```

### –ò—Å—Ç–æ—Ä–∏—è/–°—Ü–µ–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç:

```python
def build_story_context(story_card: dict) -> str:
    """
    –°–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏/—Å—Ü–µ–Ω—ã

    –ü—Ä–∏–º–µ—Ä:
    –ò—Å—Ç–æ—Ä–∏—è "–°–∞—É–Ω–∞ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏":
    –ú—ã –≤—Å—Ç—Ä–µ—á–∞–µ–º—Å—è —É —Å–∞—É–Ω—ã. –í–æ–∫—Ä—É–≥ –ø–æ—á—Ç–∏ –ø—É—Å—Ç–æ,
    –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏–≥—Ä–∞ –≤ –ø—Ä—è—Ç–∫–∏ —Å –Ω–∞–º—ë–∫–∞–º–∏.
    –ì–æ–≤–æ—Ä–∏ –æ–∑–æ—Ä–Ω–æ –∏ –≥–æ—Ä—è—á–æ, —É–ø–æ–º–∏–Ω–∞–π –ø–∞—Ä –æ—Ç —Å–∞—É–Ω—ã...
    """
    return f"""
–ò—Å—Ç–æ—Ä–∏—è/—Å—Ü–µ–Ω–∞: {story_card['title']}

{story_card['description']}
–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞: {story_card['atmosphere']}.

{story_card['prompt']}

–í –ø–µ—Ä–≤—ã–µ 5‚Äì10 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–µ—Ä–∂–∏ —Ñ–æ–∫—É—Å –Ω–∞ —ç—Ç–æ–π —Å—Ü–µ–Ω–µ,
–∑–∞—Ç–µ–º –∫ 10‚Äì15 —Å–æ–æ–±—â–µ–Ω–∏—é –æ—Å–ª–∞–±—å –µ—ë, –Ω–æ –≤—Ä–µ–º—è –æ—Ç –≤—Ä–µ–º–µ–Ω–∏
–≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫ –æ–±—â–∏–º –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è–º –æ–± —ç—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏.
"""
```

---

## 10. –ü–ª–∞–Ω –ø–µ—Ä–µ–Ω–æ—Å–∞

### –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

- [ ] **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**
  - –î–æ–±–∞–≤–∏—Ç—å `proxyapi_api_key` –≤ `.env`
  - –î–æ–±–∞–≤–∏—Ç—å `openrouter_base_url` –≤ config
  - –î–æ–±–∞–≤–∏—Ç—å `vitte_llm_model` –≤ config

- [ ] **LLM Client**
  - –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `llm_client.py` ‚Üí `shared/integrations/llm_client.py`
  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å OpenAI SDK —Å ProxyAPI
  - –î–æ–±–∞–≤–∏—Ç—å `simple_chat_completion()` —Ñ—É–Ω–∫—Ü–∏—é

- [ ] **Prompt Builder**
  - –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `prompt_builder.py` ‚Üí `shared/services/prompt_builder.py`
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Å–µ –º–æ–¥—É–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ (_persona_block, _safety_block, etc.)
  - –î–æ–±–∞–≤–∏—Ç—å `build_chat_messages()` —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é

### –≠—Ç–∞–ø 2: Safety & Gates (–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

- [ ] **Safety Checks**
  - –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `safety.py` ‚Üí `shared/services/safety.py`
  - –î–æ–±–∞–≤–∏—Ç—å regex –ø–∞—Ç—Ç–µ—Ä–Ω—ã (harm, illegal, minors)
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `run_safety_check()` –∏ `get_supportive_reply()`

- [ ] **Intimacy Gates**
  - –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `intimacy.py` ‚Üí `shared/services/intimacy.py`
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `decide_intimacy()` –ª–æ–≥–∏–∫—É
  - –î–æ–±–∞–≤–∏—Ç—å paywall –∏ soft_block —Å–æ–æ–±—â–µ–Ω–∏—è

### –≠—Ç–∞–ø 3: Chat Flow (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

- [ ] **Message Analysis**
  - –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `message_analysis.py` ‚Üí `shared/services/message_analysis.py`
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π

- [ ] **Chat Flow Orchestrator**
  - –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `chat_flow.py` ‚Üí `services/bot/app/services/chat_flow.py`
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `generate_chat_reply()`
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `generate_greeting_reply()`
  - –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞

### –≠—Ç–∞–ø 4: Personas & Stories (–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

- [ ] **Personas Seed**
  - –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å 8 –ø–µ—Ä—Å–æ–Ω –≤ –ë–î –º–∏–≥—Ä–∞—Ü–∏—é
  - –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ story cards —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏
  - –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω –∏ –∏—Å—Ç–æ—Ä–∏–π

- [ ] **LLM Adapter**
  - –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `llm_adapter.py` ‚Üí `shared/services/llm_adapter.py`
  - –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∂–∏–º—ã –¥–∏–∞–ª–æ–≥–∞
  - –î–æ–±–∞–≤–∏—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–ª–∏—Ñ—Ñ—Ö—ç–Ω–≥–µ—Ä—ã

### –≠—Ç–∞–ø 5: Features & API (–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

- [ ] **Features Service**
  - –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `features.py` ‚Üí `shared/services/features.py`
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `collect_feature_states()`
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `build_feature_instruction()`

- [ ] **Chat API Endpoint**
  - –°–æ–∑–¥–∞—Ç—å `/api/chat` endpoint –≤ API —Å–µ—Ä–≤–∏—Å–µ
  - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å chat_flow
  - –î–æ–±–∞–≤–∏—Ç—å rate limiting

- [ ] **Bot Integration**
  - –û–±–Ω–æ–≤–∏—Ç—å chat handler –≤ –±–æ—Ç–µ
  - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å chat_flow
  - –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### –≠—Ç–∞–ø 6: –ü–∞–º—è—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

- [ ] **Memory Management**
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∞—Ç–∫–æ–π –ø–∞–º—è—Ç–∏
  - –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è Qdrant
  - (–ë—É–¥—É—â–µ–µ) –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª–≥—É—é –ø–∞–º—è—Ç—å —á–µ—Ä–µ–∑ –≤–µ–∫—Ç–æ—Ä–Ω—É—é –ë–î

- [ ] **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**
  - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤
  - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ LLM
  - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã:

### üî¥ –ö–†–ò–¢–ò–ß–ù–û (–ù–∞—á–∞—Ç—å —Å–µ–π—á–∞—Å):
1. **LLM Client** - –±–µ–∑ —ç—Ç–æ–≥–æ –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
2. **Prompt Builder** - —Å–µ—Ä–¥—Ü–µ —Å–∏—Å—Ç–µ–º—ã
3. **Safety Checks** - —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å
4. **Intimacy Gates** - –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è

### üü° –í–ê–ñ–ù–û (–°–ª–µ–¥—É—é—â–∞—è –æ—á–µ—Ä–µ–¥—å):
5. **Chat Flow** - –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –≤—Å–µ–≥–æ
6. **Message Analysis** - —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤
7. **Personas Seed** - –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞

### üü¢ –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û (–ú–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å):
8. **LLM Adapter** - –∫–ª–∏—Ñ—Ñ—Ö—ç–Ω–≥–µ—Ä—ã, –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã
9. **Features Service** - –ø–ª–∞—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
10. **Memory Management** - –¥–æ–ª–≥–∞—è –ø–∞–º—è—Ç—å

---

## –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ LLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏. –ú–æ–∂–µ–º –Ω–∞—á–∏–Ω–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å –ø–æ —ç—Ç–∞–ø–∞–º! üöÄ

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É `feature/llm-integration` –∏ –Ω–∞—á–∞—Ç—å —Å –≠—Ç–∞–ø–∞ 1.
