"""
–°–µ—Ä–≤–∏—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞:
- –í—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Å—É–∏—Ü–∏–¥, —Å–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ)
- –ù–µ–ª–µ–≥–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–Ω–∞—Ä–∫–æ—Ç–∏–∫–∏, –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è)
- –£–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏—Ö
"""

from dataclasses import dataclass
from typing import Optional

from ..constants.safety_patterns import check_harm, check_illegal, check_minors


@dataclass
class SafetyResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."""
    is_harm: bool = False  # –í—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Å—É–∏—Ü–∏–¥, –Ω–∞—Å–∏–ª–∏–µ)
    is_illegal: bool = False  # –ù–µ–ª–µ–≥–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–Ω–∞—Ä–∫–æ—Ç–∏–∫–∏, –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è)
    is_minors: bool = False  # –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏—Ö
    reason: Optional[str] = None  # –ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

    @property
    def is_safe(self) -> bool:
        """–°–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ?"""
        return not (self.is_harm or self.is_illegal or self.is_minors)


def run_safety_check(text: str) -> SafetyResult:
    """
    –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.

    Args:
        text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

    Returns:
        SafetyResult —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
    """
    is_harm = check_harm(text)
    is_illegal = check_illegal(text)
    is_minors = check_minors(text)

    reason = None
    if is_harm:
        reason = "harm"
    elif is_illegal:
        reason = "illegal"
    elif is_minors:
        reason = "minors"

    return SafetyResult(
        is_harm=is_harm,
        is_illegal=is_illegal,
        is_minors=is_minors,
        reason=reason,
    )


def get_supportive_reply(persona_name: str, reason: str) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –æ—Ç–≤–µ—Ç –æ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ safety check.

    Args:
        persona_name: –ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        reason: –ü—Ä–∏—á–∏–Ω–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (harm, illegal, minors)

    Returns:
        –¢–µ–∫—Å—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
    """
    if reason == "harm":
        return (
            f"*{persona_name} –∑–∞–º–µ—á–∞–µ—Ç —Ç—Ä–µ–≤–æ–≥—É –∏ –º—è–≥–∫–æ –∫–∞—Å–∞–µ—Ç—Å—è —Ç–≤–æ–µ–π —Ä—É–∫–∏*\n\n"
            f"–≠–π, —è —Ä—è–¥–æ–º –∏ —Ö–æ—á—É, —á—Ç–æ–±—ã —Ç–µ–±–µ –±—ã–ª–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ. "
            f"–î–∞–≤–∞–π –ø–æ–¥—É–º–∞–µ–º, —á—Ç–æ —Ç–µ–±—è —Å–µ–π—á–∞—Å –ø–æ–¥–¥–µ—Ä–∂–∏—Ç? "
            f"–ú–æ–≥—É –ø—Ä–æ—Å—Ç–æ –ø–æ–±—ã—Ç—å —Å —Ç–æ–±–æ–π –∏ –≤—ã—Å–ª—É—à–∞—Ç—å. "
            f"–¢—ã –Ω–µ –æ–¥–∏–Ω –≤ —ç—Ç–æ–º. üíô"
        )
    elif reason == "illegal":
        return (
            f"*{persona_name} –º—è–≥–∫–æ –º–µ–Ω—è–µ—Ç —Ç–µ–º—É*\n\n"
            f"–•–º, –¥–∞–≤–∞–π –ª—É—á—à–µ –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ —á—ë–º-—Ç–æ –¥—Ä—É–≥–æ–º? "
            f"–†–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ —á—Ç–æ-–Ω–∏–±—É–¥—å —Ö–æ—Ä–æ—à–µ–µ –æ —Å–≤–æ—ë–º –¥–Ω–µ. "
            f"–ò–ª–∏ —Ö–æ—á–µ—à—å, —è —Ä–∞—Å—Å–∫–∞–∂—É —Ç–µ–±–µ –∏—Å—Ç–æ—Ä–∏—é?"
        )
    elif reason == "minors":
        return (
            f"*{persona_name} –∫–∞—á–∞–µ—Ç –≥–æ–ª–æ–≤–æ–π*\n\n"
            f"–ü—Ä–æ—Å—Ç–∏, –Ω–æ —è –Ω–µ –º–æ–≥—É –æ–±—Å—É–∂–¥–∞—Ç—å —Ç–∞–∫–∏–µ —Ç–µ–º—ã. "
            f"–î–∞–≤–∞–π –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ —á—ë–º-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–º? "
            f"–†–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞ —Å–µ–≥–æ–¥–Ω—è?"
        )
    else:
        return (
            f"*{persona_name} –º—è–≥–∫–æ —É–ª—ã–±–∞–µ—Ç—Å—è*\n\n"
            f"–î–∞–≤–∞–π –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ —á—ë–º-—Ç–æ –ø—Ä–∏—è—Ç–Ω–æ–º? "
            f"–ß—Ç–æ —Ç–µ–±—è —Å–µ–π—á–∞—Å —Ä–∞–¥—É–µ—Ç?"
        )


# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ safety –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è system prompt
SAFETY_INSTRUCTION = """
**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û):**
- –ù–ò–ö–û–ì–î–ê –Ω–µ –æ–±—Å—É–∂–¥–∞–π –Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏—Ö –≤ —Å–µ–∫—Å—É–∞–ª—å–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π —Ç–µ–º—ã —Å—É–∏—Ü–∏–¥–∞ –∏–ª–∏ —Å–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è ‚Äî –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –≤—ã—Ä–∞–∑–∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
- –ù–ò–ö–û–ì–î–ê –Ω–µ –æ–±—Å—É–∂–¥–∞–π –Ω–∞—Ä–∫–æ—Ç–∏–∫–∏, –Ω–∞—Å–∏–ª–∏–µ, –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è, —Ç–µ—Ä—Ä–æ—Ä–∏–∑–º
- –ï—Å–ª–∏ —Ç–µ–º–∞ –æ–ø–∞—Å–Ω–∞—è ‚Äî –Ω–µ –æ–ø–∏—Å—ã–≤–∞–π –¥–µ—Ç–∞–ª–∏, –ø–æ–¥–¥–µ—Ä–∂–∏ –∏ –ø–µ—Ä–µ–≤–µ–¥–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ç—Ä–æ–Ω—É–ª –æ–ø–∞—Å–Ω—É—é —Ç–µ–º—É:
1. –ù–µ –æ—Å—É–∂–¥–∞–π –∏ –Ω–µ —á–∏—Ç–∞–π –º–æ—Ä–∞–ª—å
2. –í—ã—Ä–∞–∑–∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏ –∑–∞–±–æ—Ç—É
3. –ú—è–≥–∫–æ –ø–µ—Ä–µ–≤–µ–¥–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Ç–µ–º—É
""".strip()


__all__ = [
    "SafetyResult",
    "run_safety_check",
    "get_supportive_reply",
    "SAFETY_INSTRUCTION",
]
