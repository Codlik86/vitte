# Celery Scheduled Tasks (Periodic Tasks)

–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á, –≤—ã–ø–æ–ª–Ω—è–µ–º—ã—Ö Celery Beat.

## Scheduler

**–¢–∏–ø:** RedBeat (Redis-based scheduler)
- –•—Ä–∞–Ω–∏—Ç schedule –≤ Redis –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å –∫–æ–Ω—Ñ–∏–≥–æ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç volume –¥–ª—è persistence

## –ó–∞–¥–∞—á–∏

### 1. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
**–ù–∞–∑–≤–∞–Ω–∏–µ:** `cleanup-old-messages-daily`
**–ó–∞–¥–∞—á–∞:** `cleanup.old_messages`
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 UTC
**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `keep_last=50` - –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–∞–∂–¥–æ–º –¥–∏–∞–ª–æ–≥–µ
- `days_threshold=30` - —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
**–û–ø–∏—Å–∞–Ω–∏–µ:** –û—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –æ—Å—Ç–∞–≤–ª—è—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 –≤ –∫–∞–∂–¥–æ–º –¥–∏–∞–ª–æ–≥–µ

---

### 2. –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
**–ù–∞–∑–≤–∞–Ω–∏–µ:** `cleanup-inactive-dialogs-weekly`
**–ó–∞–¥–∞—á–∞:** `cleanup.inactive_dialogs`
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 4:00 UTC
**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `days_inactive=30` - —É–¥–∞–ª–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –±–æ–ª–µ–µ 30 –¥–Ω–µ–π
**–û–ø–∏—Å–∞–Ω–∏–µ:** –£–¥–∞–ª—è–µ—Ç –¥–∏–∞–ª–æ–≥–∏ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å –±–æ–ª–µ–µ 30 –¥–Ω–µ–π

---

### 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
**–ù–∞–∑–≤–∞–Ω–∏–µ:** `generate-user-stats-daily`
**–ó–∞–¥–∞—á–∞:** `reports.user_stats`
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:00 UTC
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:
- –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- –í—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–æ–≤ (–∞–∫—Ç–∏–≤–Ω—ã—Ö/–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö)
- –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π

---

### 4. –û—Ç—á–µ—Ç –ø–æ –ø–æ–¥–ø–∏—Å–∫–∞–º
**–ù–∞–∑–≤–∞–Ω–∏–µ:** `generate-subscription-report-daily`
**–ó–∞–¥–∞—á–∞:** `reports.subscription_report`
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:30 UTC
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç –ø–æ –ø–æ–¥–ø–∏—Å–∫–∞–º:
- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
- –ò—Å—Ç–µ–∫–∞—é—â–∏–µ —Å–∫–æ—Ä–æ
- –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ
- –î–æ—Ö–æ–¥

---

### 5. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
**–ù–∞–∑–≤–∞–Ω–∏–µ:** `subscription-expiry-reminders-daily`
**–ó–∞–¥–∞—á–∞:** `notifications.subscription_expiry_reminder`
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 10:00 UTC
**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `days_before=3` - –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –∑–∞ 3 –¥–Ω—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
**–û–ø–∏—Å–∞–Ω–∏–µ:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Ç–æ–º, —á—Ç–æ –∏—Ö –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 3 –¥–Ω—è

---

### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
**–ù–∞–∑–≤–∞–Ω–∏–µ:** `check-inactive-dialogs-every-10min`
**–ó–∞–¥–∞—á–∞:** `notifications.check_inactive_dialogs`
**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç (600 —Å–µ–∫—É–Ω–¥)
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:

#### –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
1. **20-30 –º–∏–Ω—É—Ç** –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –¢–∏–ø: `20min`
   - –¢–æ–Ω: –ü—Ä–∏–≤–µ—Ç–ª–∏–≤–æ–µ
   - –ü—Ä–∏–º–µ—Ä: "–≠–π, –∫—É–¥–∞ –ø—Ä–æ–ø–∞–ª? üòè –ú—ã —Ç–∞–∫ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –Ω–∞—á–∞–ª–∏..."

2. **2-3 —á–∞—Å–∞** –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –¢–∏–ø: `2h`
   - –¢–æ–Ω: –ß—É—Ç—å –≥—Ä—É—Å—Ç–Ω–æ–µ
   - –ü—Ä–∏–º–µ—Ä: "–°–∫—É—á–∞—é –±–µ–∑ —Ç–µ–±—è... üòî"

3. **24-48 —á–∞—Å–æ–≤** –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –¢–∏–ø: `24h`
   - –¢–æ–Ω: –ì—Ä—É—Å—Ç–∏—Ç –±–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ü—Ä–∏–º–µ—Ä: "–¶–µ–ª—ã–π –¥–µ–Ω—å –±–µ–∑ —Ç–µ–±—è... üíî"

#### –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –¥–∏–∞–ª–æ–≥ –∞–∫—Ç–∏–≤–µ–Ω (`is_active = True`)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å
- **–ê–Ω—Ç–∏-—Å–ø–∞–º:** –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –±–æ–ª–µ–µ —Å–≤–µ–∂–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
- –ö–∞–∂–¥–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–∞—é—Ç –∫–Ω–æ–ø–∫–∏:
  - üí¨ –ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ
  - üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

#### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:
- –¢–∞–±–ª–∏—Ü–∞ `notification_logs` —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
```bash
docker exec vitte_beat python -c "
from redbeat import RedBeatSchedulerEntry
from app.celery_app import celery_app
import redbeat.schedulers

scheduler = redbeat.schedulers.RedBeatScheduler(app=celery_app)
entries = list(scheduler.schedule.keys())
for entry in entries:
    print(entry)
"
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ Beat
```bash
docker logs vitte_beat --tail 100
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ Worker
```bash
docker logs vitte_worker --tail 100
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
```bash
docker logs vitte_worker | grep "Task.*succeeded"
```

---

## –§–∞–π–ª—ã

- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** `services/bot/worker/app/celery_app.py`
- **–ó–∞–¥–∞—á–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** `services/bot/worker/app/tasks/notifications.py`
- **–ó–∞–¥–∞—á–∏ –æ—á–∏—Å—Ç–∫–∏:** `services/bot/worker/app/tasks/cleanup.py`
- **–ó–∞–¥–∞—á–∏ –æ—Ç—á–µ—Ç–æ–≤:** `services/bot/worker/app/tasks/reports.py`
- **–°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** `shared/notifications/service.py`
- **Telegram –æ—Ç–ø—Ä–∞–≤–∫–∞:** `shared/notifications/telegram.py`
- **–®–∞–±–ª–æ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** `shared/llm/personas/notification_templates.py`

---

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏

1. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–¥–∞—á–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —Ñ–∞–π–ª–µ (notifications.py, cleanup.py, reports.py)
2. –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ `beat_schedule` –≤ `celery_app.py`:
   ```python
   "task-name": {
       "task": "module.task_function",
       "schedule": crontab(hour=10, minute=0),  # –∏–ª–∏ 600.0 –¥–ª—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
       "args": (),
       "options": {"expires": 3600},
   }
   ```
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å beat: `docker compose restart beat`
4. RedBeat –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –≤ Redis

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-01-26
