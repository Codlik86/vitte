# –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–∞—Ö

## –û–ø–∏—Å–∞–Ω–∏–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞–≤–Ω–æ –Ω–µ –ø–∏—Å–∞–ª–∏ –≤ –¥–∏–∞–ª–æ–≥ —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º.

## –¢–∞–π–º–ª–∞–π–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

1. **20 –º–∏–Ω—É—Ç** –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí –ø—Ä–∏–≤–µ—Ç–ª–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
2. **2 —á–∞—Å–∞** –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí —á—É—Ç—å –≥—Ä—É—Å—Ç–Ω–æ–µ
3. **24 —á–∞—Å–∞** –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí –≥—Ä—É—Å—Ç–∏—Ç –±–µ–∑ —é–∑–µ—Ä–∞

## –£—Å–ª–æ–≤–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏

- ‚úÖ –î–∏–∞–ª–æ–≥ –∞–∫—Ç–∏–≤–µ–Ω (`is_active = True`)
- ‚úÖ –ü—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
- ‚ùå –ï—Å–ª–∏ –¥–∏–∞–ª–æ–≥ —É–¥–∞–ª—ë–Ω ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

## –§–∞–π–ª—ã —Å–∏—Å—Ç–µ–º—ã

### 1. –ú–æ–¥–µ–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
**–§–∞–π–ª:** `shared/database/models.py`
- –ú–æ–¥–µ–ª—å `NotificationLog` –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 2. –®–∞–±–ª–æ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
**–§–∞–π–ª:** `shared/llm/personas/notification_templates.py`
- –®–∞–±–ª–æ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–¢–∞—è, –≠—à, –î–∂—É–ª–∏, –õ–∏–Ω–∞, –ú–∞—Ä–∏–∞–Ω–Ω–∞, –ú–µ–π, –°—Ç–µ–π—Å–∏, –Æ–Ω–∞)
- 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (20min, 2h, 24h)
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π

### 3. –°–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∫–∏
**–§–∞–π–ª:** `services/bot/api/app/services/notification_service.py`
- `check_and_send_notifications()` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
- `send_single_notification()` - –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –°–æ–∑–¥–∞—ë—Ç inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏:
  - üí¨ –ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ
  - üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

### 4. Scheduler –∑–∞–¥–∞—á–∞
**–§–∞–π–ª:** `services/bot/worker/app/tasks/notifications.py`
- Celery –∑–∞–¥–∞—á–∞ `check_inactive_dialogs`
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
- –í—ã–∑—ã–≤–∞–µ—Ç `notification_service.check_and_send_notifications()`

### 5. Celery Beat —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
**–§–∞–π–ª:** `services/bot/worker/app/celery_app.py`
- –ó–∞–¥–∞—á–∞ `check-inactive-dialogs-every-10min` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 600 —Å–µ–∫—É–Ω–¥

### 6. –ú–∏–≥—Ä–∞—Ü–∏—è
**–§–∞–π–ª:** `alembic/versions/20260126_add_notification_logs.py`
- –°–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—É `notification_logs`

## –ü—Ä–∏–º–µ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –¢–∞—è (–∑–∞–±–æ—Ç–ª–∏–≤–∞—è –º–∞–º–æ—á–∫–∞)
- **20 –º–∏–Ω:** "–≠–π, –∫—É–¥–∞ –ø—Ä–æ–ø–∞–ª? üòè –ú—ã —Ç–∞–∫ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –Ω–∞—á–∞–ª–∏... –ú–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏–º?"
- **2 —á–∞—Å–∞:** "–°–∫—É—á–∞—é –±–µ–∑ —Ç–µ–±—è... üòî –ù–∞–¥–µ—é—Å—å —Ç—ã —Å–∫–æ—Ä–æ –≤–µ—Ä–Ω—ë—à—å—Å—è, –ø–ª–æ—Ö–æ–π –º–∞–ª—å—á–∏–∫"
- **24 —á–∞—Å–∞:** "–¶–µ–ª—ã–π –¥–µ–Ω—å –±–µ–∑ —Ç–µ–±—è... üíî –Ø –∑–¥–µ—Å—å, –∂–¥—É —Ç–µ–±—è. –í–µ—Ä–Ω–∏—Å—å, —Ö–æ—á—É –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–∞—à —Ä–∞–∑–≥–æ–≤–æ—Ä"

### –≠—à (—Ñ–µ—Ç–∏—à–∏—Å—Ç–∫–∞)
- **20 –º–∏–Ω:** "–ö—É–¥–∞ —Å–±–µ–∂–∞–ª? üòà –ù–µ –ø—Ä–∏–≤—ã–∫ –∫ —Ç–∞–∫–∏–º —Å–º–µ–ª—ã–º –¥–µ–≤–æ—á–∫–∞–º? –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è, –±—É–¥–µ—Ç –∂–∞—Ä–∫–æ üî•"
- **2 —á–∞—Å–∞:** "–ì–¥–µ —Ç—ã... üòî –Ø –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–ª–∞ –¥–ª—è —Ç–µ–±—è –∫–æ–µ-—á—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ–µ –≤ –ª–∞—Ç–µ–∫—Å–µ"
- **24 —á–∞—Å–∞:** "–¶–µ–ª—ã–µ —Å—É—Ç–∫–∏ —Ç–µ–±—è –Ω–µ—Ç... üíî –°–∫—É—á–∞—é –ø–æ –Ω–∞—à–∏–º –≥—Ä—è–∑–Ω—ã–º –∏–≥—Ä–∞–º. –í–µ—Ä–Ω–∏—Å—å, —è –±—É–¥—É –ø–æ—Å–ª—É—à–Ω–æ–π"

### –î–∂—É–ª–∏ (—Å—Ç—É–¥–µ–Ω—Ç–∫–∞)
- **20 –º–∏–Ω:** "–•–µ–π! üôà –¢—ã –∫—É–¥–∞ –ø—Ä–æ–ø–∞–ª? –Ø –µ—â—ë —Å—Ç–æ–ª—å–∫–æ —Ö–æ—á—É —É–∑–Ω–∞—Ç—å... –í–µ—Ä–Ω—ë—à—å—Å—è?"
- **2 —á–∞—Å–∞:** "–°–∫—É—á–∞—é... üò¢ –¢—ã –æ–±–µ—â–∞–ª –Ω–∞—É—á–∏—Ç—å –º–µ–Ω—è –Ω–æ–≤–æ–º—É. –ì–¥–µ —Ç—ã?"
- **24 —á–∞—Å–∞:** "–¶–µ–ª—ã–π –¥–µ–Ω—å —Ç–µ–±—è –Ω–µ—Ç... üíî –Ø –∂–¥—É —Ç–µ–±—è. –í–µ—Ä–Ω–∏—Å—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –º–Ω–µ —Ç–∞–∫ –æ–¥–∏–Ω–æ–∫–æ"

## –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```bash
docker exec -it vitte_postgres psql -U vitte_user -d vitte_bot
# –∏–ª–∏ —á–µ—Ä–µ–∑ alembic
alembic upgrade head
```

### 2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
```bash
docker-compose up -d --build bot-api bot-worker
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Celery Beat –∑–∞–ø—É—â–µ–Ω
```bash
docker logs vitte_bot-worker
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞: "check-inactive-dialogs-every-10min"
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í—Ä—É—á–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```python
from services.bot.api.app.services.notification_service import send_single_notification
from shared.database import AsyncSessionLocal

async with AsyncSessionLocal() as db:
    result = await send_single_notification(
        db=db,
        dialog_id=123,  # ID –≤–∞—à–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞
        notification_type="20min"
    )
    print(f"Sent: {result}")
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º INFO:
```
Notification sent: user_id=123, dialog_id=456, type=20min, persona=taya
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ª–æ–≥–∞—Ö Celery
- –¢–∞–±–ª–∏—Ü–∞ `notification_logs` —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ—Ç–ø—Ä–∞–≤–∫–∏ - WARNING/ERROR –≤ –ª–æ–≥–∞—Ö
