# Архитектура чатов Vitte

> Документ утверждён: 2026-01-17

---

## Решение: Один активный чат на пользователя

### Обоснование

**Продуктовое:**
- Романтический компаньон = одна история отношений
- Множественные сессии разрушают иллюзию
- Проще UX для пользователя

**Техническое:**
- Слабый сервер → меньше данных
- Проще context management
- Меньше edge cases

---

## Flow кнопки "Начать общение"

```
"💕 Начать общение" (inline кнопка или команда /chat)
    ↓
Проверяем: есть ли активный диалог с персонажем?
    ↓
┌─ Да (есть диалог) ──────────────────────────────┐
│  Показываем:                                     │
│  "Продолжить с [Персонаж]?"                      │
│  [Продолжить общение] [Начать заново]            │
│                                                  │
│  "Начать заново" = очистка memory + новый диалог │
└──────────────────────────────────────────────────┘
    ↓
┌─ Нет (нет диалога / нет персонажа) ─────────────┐
│  Открываем Web App для выбора персонажа         │
│  → CharactersList → CharacterDetails            │
│  → выбор story → "Начать разговор"              │
└──────────────────────────────────────────────────┘
```

---

## Сепарация Web App и Inline логики

**Принцип:** Web App и Inline кнопки ведут к одному результату разными путями.

| Действие | Inline (Telegram) | Web App |
|----------|-------------------|---------|
| Выбор персонажа | Нет (открывает Web App) | CharactersList → CharacterDetails |
| Выбор истории | Нет (открывает Web App) | Story cards на CharacterDetails |
| Продолжить чат | Inline кнопка | Нет (возврат в Telegram) |
| Начать заново | Inline кнопка | "Обновить и продолжить" |
| Подписка | Inline → Telegram Stars | Paywall → Telegram Stars |
| Настройки | Inline меню | Settings page |

**Важно:**
- Web App = выбор персонажа, настройки, покупки
- Telegram чат = само общение с AI
- Обе точки входа ведут к одному состоянию в БД

---

## Хранение данных

| Данные | Хранилище | Причина |
|--------|-----------|---------|
| Выбранный персонаж | PostgreSQL (users.active_persona_id) | Персистентно |
| Выбранная история | PostgreSQL (dialogs.story_id) | Привязано к диалогу |
| Последние сообщения | PostgreSQL + Redis кеш | Для LLM контекста |
| Онлайн статус | Redis only | Временные данные |

### Что НЕ хранить в Redis:
- Персонажей и сценарии (статика в БД)
- Историю диалогов (PostgreSQL)

---

## Статус

- [x] Архитектура утверждена
- [ ] Реализация handler "Начать общение"
- [ ] Интеграция с Web App
- [ ] LLM интеграция
